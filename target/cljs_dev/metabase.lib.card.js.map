{"version":3,"sources":["metabase/lib/card.cljc"],"mappings":"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","names":["metabase.lib.metadata.calculation/display-name-method","_query","_stage-number","card-metadata","_style","cljs.core.some_fn","metabase.lib.metadata.calculation/metadata-method","p__77806","map__77807","cljs.core/--destructure-map","cljs.core.get","card-name","display-name","G__77808","cljs.core/not","cljs.core.assoc","metabase.util.humanization/name->human-readable-name","metabase.lib.metadata.calculation/display-info-method","query","stage-number","G__77809","fexpr__77810","cljs.core/get-method","cljs.core._EQ_","metabase.lib.metadata.calculation/visible-columns-method","p__77811","p__77812","map__77813","map__77814","fields","result-metadata","include-implicitly-joinable?","unique-name-fn","options","cljs.core.concat","metabase.lib.metadata.calculation.returned_columns","metabase.lib.metadata.calculation/implicitly-joinable-columns","metabase.lib.card/fallback-display-name","card-id","metabase.shared.util.i18n.js_i18n","cljs.core.pr_str","metabase.lib.metadata.calculation/describe-top-level-key-method","_k","map__77815","source-card","metabase.lib.util/query-stage","or__5002__auto__","temp__5804__auto__","metabase.lib.metadata/card","metabase.lib.metadata.calculation.display_name","metabase.lib.card/infer-returned-columns","metadata-providerable","card-query","metabase.lib.query/query","metabase.lib.card/Card","metabase.lib.card/*force-broken-card-refs*","metabase.lib.card/->card-metadata-column","col","card-or-id","cljs.core/update-keys","metabase.util/->kebab-case-en","G__77816","cljs.core.merge","field-id","e77817","metabase.lib.metadata/field","_","metabase.util/the-id","and__5000__auto__","cljs.core.not_EQ_","metabase.lib.card/CardColumnMetadata","metabase.lib.card/CardColumns","metabase.lib.card/*card-metadata-columns-card-ids*","metabase.lib.card/card-metadata-columns","card","cljs.core/contains?","*card-metadata-columns-card-ids*-orig-val__77818","*card-metadata-columns-card-ids*-temp-val__77819","cljs.core.conj","cols","cljs.core/not-empty","cljs.core/map?","cljs.core/sequential?","cljs.core.mapv","cljs.core.partial","metabase.lib.card/saved-question-metadata","metabase.lib.metadata.calculation/returned-columns-method","p__77820","map__77821","desired-alias","metric-query","metabase.legacy-mbql.normalize/normalize","metabase.lib.convert/->pMBQL","metabase.lib.util.update_query_stage","cljs.core/dissoc"],"sourcesContent":["(ns metabase.lib.card\n  (:require\n   [metabase.legacy-mbql.normalize :as mbql.normalize]\n   [metabase.lib.convert :as lib.convert]\n   [metabase.lib.metadata :as lib.metadata]\n   [metabase.lib.metadata.calculation :as lib.metadata.calculation]\n   [metabase.lib.query :as lib.query]\n   [metabase.lib.schema.common :as lib.schema.common]\n   [metabase.lib.schema.id :as lib.schema.id]\n   [metabase.lib.schema.metadata :as lib.schema.metadata]\n   [metabase.lib.util :as lib.util]\n   [metabase.shared.util.i18n :as i18n]\n   [metabase.util :as u]\n   [metabase.util.humanization :as u.humanization]\n   [metabase.util.malli :as mu]))\n\n(defmethod lib.metadata.calculation/display-name-method :metadata/card\n  [_query _stage-number card-metadata _style]\n  ((some-fn :display-name :name) card-metadata))\n\n(defmethod lib.metadata.calculation/metadata-method :metadata/card\n  [_query _stage-number {card-name :name, :keys [display-name], :as card-metadata}]\n  (cond-> card-metadata\n    (not display-name) (assoc :display-name (u.humanization/name->human-readable-name :simple card-name))))\n\n(defmethod lib.metadata.calculation/display-info-method :metadata/card\n  [query stage-number card-metadata]\n  (cond-> ((get-method lib.metadata.calculation/display-info-method :default) query stage-number card-metadata)\n    (= (:type card-metadata) :question) (assoc :question? true)\n    (= (:type card-metadata) :model) (assoc :model? true)\n    (= (:type card-metadata) :metric) (assoc :metric? true)))\n\n(defmethod lib.metadata.calculation/visible-columns-method :metadata/card\n  [query\n   stage-number\n   {:keys [fields result-metadata] :as card-metadata}\n   {:keys [include-implicitly-joinable? unique-name-fn] :as options}]\n  (concat\n    (lib.metadata.calculation/returned-columns query stage-number card-metadata options)\n    (when include-implicitly-joinable?\n      (lib.metadata.calculation/implicitly-joinable-columns\n        query stage-number (concat fields result-metadata) unique-name-fn))))\n\n(mu/defn fallback-display-name :- ::lib.schema.common/non-blank-string\n  \"If for some reason the metadata is unavailable. This is better than returning nothing I guess.\"\n  [card-id :- ::lib.schema.id/card]\n  (i18n/tru \"Question {0}\" (pr-str card-id)))\n\n(defmethod lib.metadata.calculation/describe-top-level-key-method :source-card\n  [query stage-number _k]\n  (let [{:keys [source-card]} (lib.util/query-stage query stage-number)]\n    (when source-card\n      (or (when-let [card-metadata (lib.metadata/card query source-card)]\n            (lib.metadata.calculation/display-name query stage-number card-metadata :long))\n          (fallback-display-name source-card)))))\n\n(mu/defn ^:private infer-returned-columns :- [:maybe [:sequential ::lib.schema.metadata/column]]\n  [metadata-providerable :- ::lib.schema.metadata/metadata-providerable\n   card-query            :- :map]\n  (when (some? card-query)\n    (lib.metadata.calculation/returned-columns (lib.query/query metadata-providerable card-query))))\n\n(def ^:private Card\n  [:map\n   {:error/message \"Card with :dataset-query\"}\n   [:dataset-query :map]])\n\n(def ^:dynamic *force-broken-card-refs*\n  \"Things are fundamentally broken because of #29763, and every time I try to fix this is ends up being a giant mess to\n  untangle. The FE currently ignores results metadata for ad-hoc queries, and thus cannot match up 'correct' Field\n  refs like 'Products__CATEGORY'... for the time being we'll have to force ID refs even when we should be using\n  nominal refs so as to not completely destroy the FE. Once we port more stuff over maybe we can fix this.\"\n  true)\n\n(mu/defn ->card-metadata-column :- ::lib.schema.metadata/column\n  \"Massage possibly-legacy Card results metadata into MLv2 ColumnMetadata.\"\n  ([metadata-providerable col]\n   (->card-metadata-column metadata-providerable nil col))\n\n  ([metadata-providerable :- ::lib.schema.metadata/metadata-providerable\n    card-or-id            :- [:maybe [:or ::lib.schema.id/card ::lib.schema.metadata/card]]\n    col                   :- :map]\n   (let [col (-> col\n                 (update-keys u/->kebab-case-en))]\n     (cond-> (merge\n              {:base-type :type/*, :lib/type :metadata/column}\n              (when-let [field-id (:id col)]\n                (try\n                  (lib.metadata/field metadata-providerable field-id)\n                  (catch #?(:clj Throwable :cljs :default) _\n                    nil)))\n              col\n              {:lib/type                :metadata/column\n               :lib/source              :source/card\n               :lib/source-column-alias ((some-fn :lib/source-column-alias :name) col)})\n       card-or-id\n       (assoc :lib/card-id (u/the-id card-or-id))\n\n       (and *force-broken-card-refs*\n            ;; never force broken refs for Models, because Models can have give columns with completely\n            ;; different names the Field ID of a different column, somehow. See #22715\n            (or\n             ;; we can only do this check if `card-or-id` is passed in.\n             (not card-or-id)\n             (not= (:type (lib.metadata/card metadata-providerable (u/the-id card-or-id)))\n                   :model)))\n       (assoc ::force-broken-id-refs true)\n\n       ;; If the incoming col doesn't have `:semantic-type :type/FK`, drop `:fk-target-field-id`.\n       ;; This comes up with metadata on SQL cards, which might be linked to their original DB field but should not be\n       ;; treated as FKs unless the metadata is configured accordingly.\n       (not= (:semantic-type col) :type/FK)\n       (assoc :fk-target-field-id nil)))))\n\n(def ^:private CardColumnMetadata\n  [:merge\n   ::lib.schema.metadata/column\n   [:map\n    [:lib/source [:= :source/card]]]])\n\n(def ^:private CardColumns\n  [:maybe [:sequential {:min 1} CardColumnMetadata]])\n\n(def ^:private ^:dynamic *card-metadata-columns-card-ids*\n  \"Used to track the ID of Cards we're resolving columns for, to avoid inifinte recursion for Cards that have circular\n  references between one another.\"\n  #{})\n\n(mu/defn card-metadata-columns :- CardColumns\n  \"Get a normalized version of the saved metadata associated with Card metadata.\"\n  [metadata-providerable :- ::lib.schema.metadata/metadata-providerable\n   card                  :- Card]\n  (when-not (contains? *card-metadata-columns-card-ids* (:id card))\n    (binding [*card-metadata-columns-card-ids* (conj *card-metadata-columns-card-ids* (:id card))]\n      (when-let [result-metadata (or (:fields card)\n                                     (:result-metadata card)\n                                     (infer-returned-columns metadata-providerable (:dataset-query card)))]\n        ;; Card `result-metadata` SHOULD be a sequence of column infos, but just to be safe handle a map that\n        ;; contains` :columns` as well.\n        (when-let [cols (not-empty (cond\n                                     (map? result-metadata)        (:columns result-metadata)\n                                     (sequential? result-metadata) result-metadata))]\n          (mapv (partial ->card-metadata-column metadata-providerable card)\n                cols))))))\n\n(mu/defn saved-question-metadata :- CardColumns\n  \"Metadata associated with a Saved Question with `card-id`.\"\n  [metadata-providerable :- ::lib.schema.metadata/metadata-providerable\n   card-id               :- ::lib.schema.id/card]\n  ;; it seems like in some cases (unit tests) the FE is renaming `:result-metadata` to `:fields`, not 100% sure why\n  ;; but handle that case anyway. (#29739)\n  (when-let [card (lib.metadata/card metadata-providerable card-id)]\n    (card-metadata-columns metadata-providerable card)))\n\n(defmethod lib.metadata.calculation/returned-columns-method :metadata/card\n  [query _stage-number card {:keys [unique-name-fn], :as options}]\n  (mapv (fn [col]\n          (let [desired-alias ((some-fn :lib/desired-column-alias :lib/source-column-alias :name) col)]\n            (assoc col :lib/desired-column-alias (unique-name-fn desired-alias))))\n        (if (= (:type card) :metric)\n          (let [metric-query (-> card :dataset-query mbql.normalize/normalize lib.convert/->pMBQL\n                                 (lib.util/update-query-stage -1 dissoc :aggregation :breakout))]\n            (not-empty (lib.metadata.calculation/returned-columns\n                        (assoc metric-query :lib/metadata (:lib/metadata query))\n                        -1\n                        (lib.util/query-stage metric-query -1)\n                        options)))\n          (card-metadata-columns query card))))\n"]}